<?xml version="1.0"?>
<!-- 
  * build.xml
  *
  *      Authors: Matt Jones
  *    Copyright: 2000 Regents of the University of California and the
  *               National Center for Ecological Analysis and Synthesis
  *  For Details: http://www.nceas.ucsb.edu/
  *    File Info: '$Id: build.xml,v 1.32 2001-10-23 21:59:48 jones Exp $'
  *
  *  Build file for the Ant cross-platform build system for metacat
  *  See http://jakarta.apache.org for details on Ant
  *
  * usage: ant [compile|jar|install|jdoc]
--> 
<project name="morpho" default="install" basedir=".">
   <target name="init">
      <property name="name" value="morpho"/>
      <property name="Name" value="Morpho Data Management Client"/>
      <property name="release" value="1.0.0beta1"/>

      <filter token="release" value="${release}"/>

      <filter token="server" value="http://knb.ecoinformatics.org"/>
      <filter token="docrooturl" value="/"/>

      <property name="itisdir" value="../itislib" />
      <property name="srcdir" value="./src" />
      <property name="libdir" value="./lib" />

      <property name="build.dir" value="./build"/>
      <property name="build.src" value="${build.dir}/src"/>
      <property name="build.dest" value="${build.dir}/classes"/>
      <property name="build.docs" value="${build.dir}/docs"/>
      <property name="build.samples" value="${build.dir}/samples"/>
      <property name="build.tests" value="${build.dir}/tests"/>
      <property name="build.data" value="${build.dir}/data"/>
      <property name="build.javadocs" value="${build.dir}/docs/api"/>

      <property name="dist.dir" value="./dist"/>
      <property name="morpho.dir" value="${dist.dir}/morpho-${release}"/>
      <property name="morpho.lib" value="${morpho.dir}/lib"/>
      <property name="morpho.lib.catalog" value="${morpho.lib}/catalog"/>
      <property name="morpho.lib.frames" value="${morpho.lib}/frames"/>
      <property name="morpho.lib.sampledata" value="${morpho.lib}/sampledata"/>
      <property name="morpho.lib.style" value="${morpho.lib}/style"/>
      <property name="morpho.lib.HTTPClient" value="${morpho.lib}/HTTPClient"/>
      <property name="morpho.src" value="${morpho.dir}/src"/>
      <property name="morpho.docs" value="${morpho.dir}/docs"/>
      <property name="morpho.docs.dev" value="${morpho.docs}/dev"/>
      <property name="morpho.docs.dev.api" value="${morpho.docs.dev}/api"/>

      <property name="xml4j" 
                value="${libdir}/xml4j.jar" />
      <property name="xerces" 
                value="${libdir}/xerces.jar" />
      <property name="xalan" 
                value="${libdir}/xalan.jar" />
      <property name="sym" 
                value="${libdir}/sym.jar" />
      <property name="dtd" 
                value="${libdir}/dtdparser111.jar" />
      <property name="morpho" 
                value="${libdir}/${name}.jar" />
      <property name="junit" 
                value="${libdir}/junit.jar" />
      <property name="jlf" 
                value="${libdir}/jlfgr-1_0.jar" />
      <property name="itisjar"
                value="${libdir}/itislib.jar" />
      <property name="httpclient" 
                value="lib/httpclient.jar" />
      <property name="cpath" 
                value="${xerces}:${xalan}:${xml4j}:${build.dest}:${sym}:${dtd}:${junit}:${jlf}:${itisjar}:${httpclient}"/>
      <property name="package.home" value="edu/ucsb/nceas" />

   </target>
   
   <target name="prepare" depends="init">
      <mkdir dir="${build.dir}"/>
      <mkdir dir="${build.src}"/>
      <mkdir dir="${build.dest}"/>

       <!--
      <copy todir="${build.src}" filtering="no">
        <fileset dir="${srcdir}">
          <exclude name="**/CVS*"/>
          <exclude name="**/.#*"/>
        </fileset>
      </copy>
       -->
   </target>

   <!--
   <target name="compile" depends="itis,prepare">
   -->
   <target name="compile" depends="prepare">

      <jar jarfile="lib/httpclient.jar">
        <fileset dir="lib" includes="HTTPClient/**/*.class"/>
      </jar>

      <javac srcdir="${srcdir}" 
             destdir="${build.dest}" 
             classpath="${cpath}" /> 
   </target> 

   <target name="jar" depends="compile">
      <delete file="${build.dir}/${name}.jar" />
      <copy todir="${build.dest}/${package.home}/morpho/framework" filtering="no">
        <fileset dir="${srcdir}/${package.home}/morpho/framework/images">
        </fileset>
      </copy>
      <copy todir="${build.dest}/${package.home}/morpho/query" filtering="no">
        <fileset dir="${srcdir}/${package.home}/morpho/query/images">
        </fileset>
      </copy>
      <copy todir="${build.dest}/${package.home}/morpho/editor" filtering="no">
        <fileset dir="${srcdir}/${package.home}/morpho/editor/images">
        </fileset>
      </copy>
      <jar jarfile="${build.dir}/${name}.jar" basedir="${build.dest}" />
   </target> 

   <target name="install" depends="jar">
      <copy file="${build.dir}/${name}.jar" todir="${libdir}" />
      <echo message="Install complete. Use the morpho script to run it." />
   </target>

   <target name="dist" depends="install,docs,jdoc">
      <mkdir dir="${dist.dir}"/>
      <delete dir="${morpho.dir}" />
      <mkdir dir="${morpho.dir}"/>
      <mkdir dir="${morpho.lib}"/>
      <mkdir dir="${morpho.lib.catalog}"/>
      <mkdir dir="${morpho.lib.frames}"/>
      <mkdir dir="${morpho.lib.sampledata}"/>
      <mkdir dir="${morpho.lib.style}"/>
      <mkdir dir="${morpho.docs}"/>
      <mkdir dir="${morpho.docs.dev}"/>
      <mkdir dir="${morpho.docs.dev.api}"/>
      <copy file="./LICENSE" todir="${morpho.dir}"/>
      <copy file="./morpho" todir="${morpho.dir}"/>
      <copy file="./morpho.bat" todir="${morpho.dir}"/>
      <copy file="./README.txt" todir="${morpho.dir}"/>
      <copy todir="${morpho.lib.catalog}">
        <fileset dir="./lib/catalog"/>
      </copy>
      <copy todir="${morpho.lib.frames}">
        <fileset dir="./lib/frames"/>
      </copy>
      <copy todir="${morpho.lib.sampledata}">
        <fileset dir="./lib/sampledata"/>
      </copy>
      <copy todir="${morpho.lib.style}">
        <fileset dir="./lib/style"/>
      </copy>
      <copy todir="${morpho.docs}">
        <fileset dir="${build.docs}">
          <exclude name="**/api"/>
        </fileset>
      </copy>
      <copy todir="${morpho.docs.dev}">
        <fileset dir="./docs/dev"/>
      </copy>
      <copy todir="${morpho.docs.dev.api}">
        <fileset dir="${build.docs}/api"/>
      </copy>
      <delete file="./lib/config.xml" />
      <cvs command="update lib/config.xml" />
      <copy file="./lib/config.xml" todir="${morpho.lib}"/>
      <copy file="./lib/dataset.xml" todir="${morpho.lib}"/>
      <copy file="./lib/eml-variable.xml" todir="${morpho.lib}"/>
      <copy file="./lib/table-entity.xml" todir="${morpho.lib}"/>
      <copy file="./lib/default-profile.xml" todir="${morpho.lib}"/>
      <copy file="./lib/itislib.jar" todir="${morpho.lib}"/>
      <copy file="./lib/jlfgr-1_0.jar" todir="${morpho.lib}"/>
      <copy file="./lib/morpho.jar" todir="${morpho.lib}"/>
      <copy file="./lib/xalan.jar" todir="${morpho.lib}"/>
      <copy file="./lib/xerces.jar" todir="${morpho.lib}"/> 
      <copy file="./lib/httpclient.jar" todir="${morpho.lib}"/> 
       
      <delete file="./lib/morpho-${release}.zip"/>
      <zip zipfile="./lib/morpho-${release}.zip" basedir="${dist.dir}"/>
      <delete file="./lib/morpho-${release}.tar.gz" />
      <tar tarfile="./lib/morpho-${release}.tar" basedir="${dist.dir}"/>
      <gzip zipfile="./lib/morpho-${release}.tar.gz" 
                src="./lib/morpho-${release}.tar"/>
      <delete file="./lib/morpho-${release}.tar" />
  </target> 

  <target name="distsrc" depends="dist">
      <mkdir dir="${morpho.src}"/>
      <copy todir="${morpho.src}">
        <fileset dir="./src"/>
      </copy>
      <mkdir dir="${morpho.lib.HTTPClient}"/>
      <copy todir="${morpho.lib.HTTPClient}">
        <fileset dir="./lib/HTTPClient"/>
      </copy>

      <delete file="./lib/morpho-src-${release}.zip"/>
      <zip zipfile="./lib/morpho-src-${release}.zip" basedir="${dist.dir}"/>
      <delete file="./lib/morpho-src-${release}.tar.gz" />
      <tar tarfile="./lib/morpho-src-${release}.tar" basedir="${dist.dir}"/>
      <gzip zipfile="./lib/morpho-src-${release}.tar.gz" 
                src="./lib/morpho-src-${release}.tar"/>
      <delete file="./lib/morpho-src-${release}.tar" />
  </target> 

   <target name="clean" depends="init">
       <delete dir="${build.dir}" />
       <delete dir="${morpho.dir}" />
   </target>

   <target name="docs" depends="init">
     <mkdir dir="${build.docs}"/>
     <copy todir="${build.docs}" filtering="no">
       <fileset dir="./docs/user">
          <exclude name="**/*.html"/>
       </fileset>
     </copy>
     <copy todir="${build.docs}" filtering="yes">
       <fileset dir="./docs/user">
         <include name="*.html"/>
       </fileset>
     </copy>
   </target>

   <target name="jdoc" depends="init">
       <mkdir dir="${build.javadocs}" />
       <javadoc packagenames="edu.ucsb.nceas.*"
           sourcepath="src"
           destdir="${build.javadocs}"
           author="true"
           version="true"
           use="true"
           windowtitle="${Name} API"
           doctitle="&lt;h1&gt;${Name}&lt;/h1&gt;"
           bottom="&lt;i&gt;Copyright &#169; 2000 National Center for Ecological Analysis and Synthesis. All Rights Reserved.&lt;/i&gt;"
       />
   </target>

   <target name="morpho" depends="install">
     <java classname="edu.ucsb.nceas.morpho.framework.ClientFramework"
           classpath="${cpath}:${morpho}"
           fork="yes" >
       <arg value="-Xmx128m"/>
       <jvmarg line="-Djava.protocol.handler.pkgs=HTTPClient"/>
     </java>
   </target>
   
   <target name="wizard" depends="install">
     <java classname="edu.ucsb.nceas.morpho.datapackage.wizard.PackageWizard"
           classpath="${cpath}:${morpho}"
           fork="yes">
           <arg file="src/edu/ucsb/nceas/morpho/datapackage/wizard/wizardTest.xml"/>
     </java>
   </target>
   
   <target name="mdstore" depends="install">
     <java classname="edu.ucsb.nceas.morpho.framework.MetacatDataStore"
           classpath="${cpath}:${morpho}"
           fork="yes">
       <arg line="jones some-password h.1.1 build.xml data.1.1 morpho.bat"/>
       <jvmarg line="-Djava.protocol.handler.pkgs=HTTPClient"/>
     </java>
   </target>
   
   <!-- use the ant "junit" task to run JUnit tests. -->
   <target name="test" depends="install">
     <!-- this currently does not work for CLientFramework
          because of a problem with Class.getResource() calls
          in ClientFramework.  Looks like its probably a ClassLoader
          issue, but I'm not sure.  You can instead use the "junit"
          target that I manually configured below -->
     <junit printsummary="yes" haltonfailure="no" fork="no"
            haltonerror="yes">
       <classpath>
         <pathelement path="${cpath}:${morpho}:${junit}" />
       </classpath>
       
       <formatter type="plain" />
       
       <test name="edu.ucsb.nceas.morpho.framework.tests.ConnectTest"/>
       <!--
       <batchtest fork="yes" todir="${reports.tests}">
         <fileset dir="${src.tests}">
           <include name="**/*Test*.java" />
           <exclude name="**/AllTests.java" />
         </fileset>
       </batchtest>
       -->
     </junit>
   </target>

   <!-- Manually run JUnit by calling the TestRunner program.
        Obviously, this requires Junit to be available on the
        classpath -->
   <target name="junit" depends="install">
     <java classname="junit.textui.TestRunner"
           classpath="${cpath}:${morpho}:${junit}"
           fork="yes">
       <arg line="edu.ucsb.nceas.morpho.framework.tests.ConnectTest"/>
     </java>
   </target>

   <!-- build the itis library for querying ITIS -->
   <target name="itis" depends="init">
     <ant dir="${itisdir}" />
     <copy file="${itisdir}/lib/itislib.jar" todir="${libdir}" />
   </target>
   
</project>
